<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>üöå Pr√≥ximos Autocarros</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #13131a;
      --surface2: #1c1c26;
      --border: rgba(255,255,255,0.07);
      --accent: #f5a623;
      --accent2: #e85d04;
      --text: #f0f0f5;
      --muted: #6b6b80;
      --green: #00c875;
      --red: #ff4444;
      --yellow: #f5a623;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* Background texture */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245,166,35,0.08) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(232,93,4,0.06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 16px 40px;
      position: relative;
      z-index: 1;
    }

    /* HEADER */
    header {
      padding: 48px 0 32px;
      text-align: center;
    }

    .header-icon {
      font-size: 36px;
      display: block;
      margin-bottom: 12px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    h1 {
      font-family: 'Space Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }

    h1 span {
      color: var(--accent);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 300;
    }

    /* STATUS BAR */
    #status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
    }

    .status-dot.active {
      background: var(--green);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    .status-dot.error {
      background: var(--red);
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* LOCATE BUTTON */
    #locate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      border-radius: 14px;
      color: #0a0a0f;
      font-family: 'DM Sans', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 24px;
      transition: transform 0.15s, opacity 0.15s;
      position: relative;
      overflow: hidden;
    }

    #locate-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.15);
      opacity: 0;
      transition: opacity 0.15s;
    }

    #locate-btn:hover::after { opacity: 1; }
    #locate-btn:active { transform: scale(0.98); }
    #locate-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* RADIUS SELECTOR */
    .radius-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .radius-label {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .radius-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
      font-family: 'Space Mono', monospace;
    }

    .chip.active {
      background: var(--accent);
      color: #0a0a0f;
      border-color: var(--accent);
      font-weight: 700;
    }

    /* UPDATE INFO */
    .update-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .section-title {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #refresh-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 12px;
      padding: 4px 10px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #refresh-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* STOPS LIST */
    #stops-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* STOP CARD */
    .stop-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      animation: slide-in 0.3s ease forwards;
    }

    @keyframes slide-in {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stop-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .stop-distance {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      color: var(--accent);
      background: rgba(245,166,35,0.1);
      border: 1px solid rgba(245,166,35,0.2);
      border-radius: 6px;
      padding: 2px 7px;
      white-space: nowrap;
      margin-top: 2px;
    }

    .stop-name {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
    }

    .stop-id {
      font-size: 11px;
      color: var(--muted);
      font-family: 'Space Mono', monospace;
      margin-top: 2px;
    }

    /* ARRIVALS */
    .arrivals-list {
      padding: 8px 0;
    }

    .arrival-row {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .arrival-row:last-child { border-bottom: none; }
    .arrival-row:hover { background: var(--surface2); }

    .line-badge {
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 8px;
      min-width: 52px;
      text-align: center;
      flex-shrink: 0;
    }

    .arrival-info {
      flex: 1;
      min-width: 0;
    }

    .arrival-headsign {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .arrival-scheduled {
      font-size: 11px;
      color: var(--muted);
      margin-top: 1px;
    }

    .arrival-time {
      text-align: right;
      flex-shrink: 0;
    }

    .time-minutes {
      font-family: 'Space Mono', monospace;
      font-size: 18px;
      font-weight: 700;
      line-height: 1;
    }

    .time-label {
      font-size: 10px;
      color: var(--muted);
      margin-top: 1px;
    }

    .time-now {
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      color: var(--green);
      background: rgba(0,200,117,0.1);
      padding: 4px 8px;
      border-radius: 8px;
    }

    /* TIME COLORS */
    .t-green { color: var(--green); }
    .t-yellow { color: var(--yellow); }
    .t-red { color: var(--red); }
    .t-muted { color: var(--muted); }

    /* LOADING SKELETON */
    .skeleton {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .skel-header { height: 56px; background: var(--surface2); }
    .skel-row {
      height: 52px;
      border-top: 1px solid var(--border);
      background: linear-gradient(90deg, var(--surface2) 25%, var(--surface) 50%, var(--surface2) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* LINES PILLS no header */
    .stop-lines {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .line-pill {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 5px;
      white-space: nowrap;
    }

    /* NO ARRIVALS */
    .no-arrivals {
      padding: 20px 16px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    /* EMPTY STATE */
    #empty-state {
      text-align: center;
      padding: 48px 24px;
      display: none;
    }

    #empty-state .big-icon { font-size: 56px; margin-bottom: 16px; }
    #empty-state h2 { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
    #empty-state p { font-size: 14px; color: var(--muted); line-height: 1.5; }

    /* LAST UPDATE */
    #last-update {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 24px;
      font-family: 'Space Mono', monospace;
    }

    /* COUNTDOWN BAR */
    .countdown-bar {
      height: 2px;
      background: var(--border);
      border-radius: 1px;
      margin: 0 16px 12px;
      overflow: hidden;
    }

    .countdown-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 1px;
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <span class="header-icon">üöå</span>
      <h1>Pr√≥ximos <span>Autocarros</span></h1>
      <p class="subtitle">Carris Metropolitana ¬∑ Tempo Real</p>
    </header>

    <div id="status-bar">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">Carrega a localiza√ß√£o para come√ßar</span>
    </div>

    <button id="locate-btn" onclick="locateMe()">
      <span>üìç</span>
      <span id="locate-label">Usar a minha localiza√ß√£o</span>
    </button>

    <div class="radius-row">
      <span class="radius-label">Raio de pesquisa:</span>
      <div class="radius-chips">
        <div class="chip" onclick="setRadius(200)">200m</div>
        <div class="chip active" onclick="setRadius(400)">400m</div>
        <div class="chip" onclick="setRadius(700)">700m</div>
        <div class="chip" onclick="setRadius(1000)">1km</div>
      </div>
    </div>

    <div class="update-info" id="update-info" style="display:none">
      <span class="section-title" id="stops-count"></span>
      <button id="refresh-btn" onclick="refresh()">
        <span id="refresh-icon">‚Üª</span> Atualizar
      </button>
    </div>

    <div id="countdown-wrap" style="display:none">
      <div class="countdown-bar">
        <div class="countdown-fill" id="countdown-fill" style="width:100%"></div>
      </div>
    </div>

    <div id="stops-container"></div>
    <div id="empty-state">
      <div class="big-icon">üó∫Ô∏è</div>
      <h2>Nenhuma paragem encontrada</h2>
      <p>N√£o h√° paragens da Carris Metropolitana num raio de <span id="empty-radius"></span>m. Tenta aumentar o raio de pesquisa.</p>
    </div>
    <div id="last-update"></div>
  </div>

  <script>
    const API = 'https://api.carrismetropolitana.pt';
    let allStops = [];
    let lineColors = {}; // cache de cores oficiais das linhas
    let userLat = null, userLon = null;
    let radius = 400;
    let autoRefreshTimer = null;
    let countdownTimer = null;
    let countdownSeconds = 30;
    let isLoading = false;

    // Usa cor oficial da API se dispon√≠vel, sen√£o gera cor a partir do ID
    function getLineColor(lineId) {
      if (lineColors[lineId]) return lineColors[lineId];
      const colors = [
        '#f5a623','#e85d04','#00c875','#4ecdc4',
        '#45b7d1','#a855f7','#ef4444','#3b82f6',
        '#10b981','#f59e0b','#ec4899','#6366f1'
      ];
      let hash = 0;
      for (let c of String(lineId)) hash = ((hash << 5) - hash) + c.charCodeAt(0);
      return colors[Math.abs(hash) % colors.length];
    }

    function setRadius(r) {
      radius = r;
      document.querySelectorAll('.chip').forEach(c => {
        c.classList.toggle('active', parseInt(c.textContent) === r || c.textContent === r+'m' || c.textContent.replace('km','') * 1000 === r);
      });
      // re-check active
      document.querySelectorAll('.chip').forEach(c => {
        const val = c.textContent === '1km' ? 1000 : parseInt(c.textContent);
        c.classList.toggle('active', val === r);
      });
      if (userLat) loadNearbyStops();
    }

    function setStatus(type, msg) {
      const dot = document.getElementById('status-dot');
      dot.className = 'status-dot' + (type === 'active' ? ' active' : type === 'error' ? ' error' : '');
      document.getElementById('status-text').textContent = msg;
    }

    async function locateMe() {
      if (!navigator.geolocation) {
        setStatus('error', 'Geolocaliza√ß√£o n√£o suportada neste browser');
        return;
      }
      const btn = document.getElementById('locate-btn');
      const label = document.getElementById('locate-label');
      btn.disabled = true;
      label.textContent = 'A obter localiza√ß√£o...';
      setStatus('', 'A obter localiza√ß√£o GPS...');

      navigator.geolocation.getCurrentPosition(
        async pos => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          btn.disabled = false;
          label.textContent = 'Atualizar localiza√ß√£o';
          await loadNearbyStops();
          startAutoRefresh();
        },
        err => {
          btn.disabled = false;
          label.textContent = 'Usar a minha localiza√ß√£o';
          setStatus('error', 'Permiss√£o de localiza√ß√£o negada');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    async function loadNearbyStops() {
      if (isLoading) return;
      isLoading = true;
      showLoading();

      try {
        if (allStops.length === 0) {
          setStatus('', 'A carregar paragens e linhas...');
          // Fetch stops e linhas em paralelo
          const [stopsRes, linesRes] = await Promise.all([
            fetch(`${API}/v2/stops`),
            fetch(`${API}/v2/lines`)
          ]);
          const stopsData = await stopsRes.json();
          const linesData = await linesRes.json();

          // Guardar cores oficiais das linhas
          const linesArr = linesData.data || linesData;
          linesArr.forEach(l => {
            if (l.id && l.color) lineColors[l.id] = l.color;
          });

          // A API devolve long_name como nome e line_ids como linhas
          const raw = stopsData.data || stopsData;
          allStops = raw.map(s => ({
            ...s,
            name: s.long_name || s.name || s.short_name || s.id,
            lines: s.line_ids || s.lines || [],
          }));
        }

        const nearby = allStops
          .map(s => ({ ...s, dist: haversine(userLat, userLon, s.lat, s.lon) }))
          .filter(s => s.dist <= radius)
          .sort((a, b) => a.dist - b.dist)
          .slice(0, 6);

        if (nearby.length === 0) {
          showEmpty();
          isLoading = false;
          return;
        }

        setStatus('active', `${nearby.length} paragem${nearby.length > 1 ? 's' : ''} encontrada${nearby.length > 1 ? 's' : ''} perto de ti`);
        document.getElementById('update-info').style.display = 'flex';
        document.getElementById('stops-count').textContent = `${nearby.length} paragem${nearby.length > 1 ? 's' : ''}`;
        document.getElementById('empty-state').style.display = 'none';

        // Endpoint correto: /v2/arrivals/by_stop/:id
        const rtResults = await Promise.allSettled(
          nearby.map(async s => {
            try {
              const res = await fetch(`${API}/v2/arrivals/by_stop/${s.id}`);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              return data.data || data;
            } catch (e) {
              console.warn(`Erro arrivals paragem ${s.id}:`, e.message);
              return [];
            }
          })
        );

        const container = document.getElementById('stops-container');
        container.innerHTML = '';

        nearby.forEach((stop, i) => {
          const rtData = rtResults[i].status === 'fulfilled' ? (rtResults[i].value || []) : [];
          container.appendChild(buildStopCard(stop, Array.isArray(rtData) ? rtData : []));
        });

        updateLastUpdate();
        isLoading = false;
      } catch (e) {
        console.error(e);
        setStatus('error', 'Erro ao carregar dados. Verifica a liga√ß√£o.');
        isLoading = false;
      }
    }

    function buildStopCard(stop, arrivals) {
      const card = document.createElement('div');
      card.className = 'stop-card';

      const distStr = stop.dist < 1000
        ? `${Math.round(stop.dist)}m`
        : `${(stop.dist/1000).toFixed(1)}km`;

      // Pills das linhas que servem esta paragem
      const lines = stop.lines || [];
      const linesPillsHtml = lines.length > 0
        ? `<div class="stop-lines">${lines.slice(0, 12).map(lid => {
            const color = getLineColor(lid);
            return `<span class="line-pill" style="background:${color}22;color:${color};border:1px solid ${color}44">${lid}</span>`;
          }).join('')}</div>`
        : '';

      card.innerHTML = `
        <div class="stop-header">
          <span class="stop-distance">${distStr}</span>
          <div style="flex:1;min-width:0">
            <div class="stop-name">${stop.name}</div>
            <div class="stop-id">#${stop.id}</div>
            ${linesPillsHtml}
          </div>
        </div>
        <div class="arrivals-list" id="arrivals-${stop.id}"></div>
      `;

      const list = card.querySelector(`#arrivals-${stop.id}`);
      const now = new Date();

      const upcoming = arrivals
        .filter(a => a.estimated_arrival || a.scheduled_arrival)
        .map(a => {
          const timeStr = a.estimated_arrival || a.scheduled_arrival;
          const [h, m, s] = timeStr.split(':').map(Number);
          const dt = new Date();
          dt.setHours(h, m, s || 0, 0);
          if (dt < now) dt.setDate(dt.getDate() + 1);
          return { ...a, dt, minutesAway: Math.round((dt - now) / 60000) };
        })
        .filter(a => a.minutesAway >= -1)
        .sort((a, b) => a.minutesAway - b.minutesAway)
        .slice(0, 5);

      if (upcoming.length === 0) {
        list.innerHTML = `<div class="no-arrivals">Sem chegadas previstas em breve</div>`;
      } else {
        upcoming.forEach(a => {
          const color = getLineColor(a.line_id);
          const mins = a.minutesAway;
          let timeHtml;

          if (mins <= 1) {
            timeHtml = `<span class="time-now">Agora</span>`;
          } else {
            const cls = mins <= 3 ? 't-green' : mins <= 8 ? 't-yellow' : 't-muted';
            timeHtml = `
              <div class="time-minutes ${cls}">${mins}</div>
              <div class="time-label">min</div>
            `;
          }

          const scheduled = a.scheduled_arrival ? a.scheduled_arrival.substring(0,5) : '';

          const row = document.createElement('div');
          row.className = 'arrival-row';
          row.innerHTML = `
            <div class="line-badge" style="background:${color}22;color:${color};border:1px solid ${color}44">${a.line_id}</div>
            <div class="arrival-info">
              <div class="arrival-headsign">${a.headsign || '‚Äî'}</div>
              ${scheduled ? `<div class="arrival-scheduled">Previsto: ${scheduled}</div>` : ''}
            </div>
            <div class="arrival-time">${timeHtml}</div>
          `;
          list.appendChild(row);
        });
      }

      return card;
    }

    function showLoading() {
      const c = document.getElementById('stops-container');
      c.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        c.innerHTML += `
          <div class="skeleton">
            <div class="skel-header"></div>
            <div class="skel-row"></div>
            <div class="skel-row"></div>
            <div class="skel-row"></div>
          </div>`;
      }
      document.getElementById('empty-state').style.display = 'none';
    }

    function showEmpty() {
      document.getElementById('stops-container').innerHTML = '';
      document.getElementById('empty-state').style.display = 'block';
      document.getElementById('empty-radius').textContent = radius;
      setStatus('error', 'Nenhuma paragem encontrada neste raio');
    }

    function updateLastUpdate() {
      const now = new Date();
      document.getElementById('last-update').textContent =
        `Atualizado √†s ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
    }

    async function refresh() {
      const icon = document.getElementById('refresh-icon');
      icon.classList.add('spin');
      await loadNearbyStops();
      icon.classList.remove('spin');
      resetCountdown();
    }

    function startAutoRefresh() {
      document.getElementById('countdown-wrap').style.display = 'block';
      resetCountdown();
    }

    function resetCountdown() {
      clearInterval(countdownTimer);
      clearTimeout(autoRefreshTimer);
      countdownSeconds = 30;
      updateCountdownBar();
      countdownTimer = setInterval(() => {
        countdownSeconds--;
        updateCountdownBar();
        if (countdownSeconds <= 0) {
          clearInterval(countdownTimer);
          loadNearbyStops().then(resetCountdown);
        }
      }, 1000);
    }

    function updateCountdownBar() {
      const pct = (countdownSeconds / 30) * 100;
      document.getElementById('countdown-fill').style.width = pct + '%';
    }
  </script>
</body>
</html>
